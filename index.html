<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>台灣各行政區｜價量趨勢</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1 { font-size: 1.5em; }
    .controls { margin-bottom: 15px; }
    .btn { margin-left: 5px; padding: 5px 10px; cursor: pointer; }
    canvas { max-width: 100%; }
  </style>
</head>
<body>
  <h1>台灣各行政區｜價量趨勢</h1>

  <div class="controls">
    <label>時間範圍：
      <select id="range">
        <option value="3">近三個月</option>
        <option value="6">近半年</option>
        <option value="12">近一年</option>
        <option value="24" selected>近兩年</option>
      </select>
    </label>
    <button id="reload" class="btn">重新載入</button>
    <button id="inspect" class="btn">檢查資料</button>
  </div>

  <canvas id="chart"></canvas>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/1Jv2mEjotjAy215KM7b9uHfIi90hcCBKnEZFeyQcr4kc/gviz/tq?tqx=out:csv&gid=0";

const el = {
  range: document.getElementById('range'),
  reload: document.getElementById('reload'),
  inspect: document.getElementById('inspect'),
  canvas: document.getElementById('chart')
};

let chart;

function parseDate(str){
  // 嘗試常見格式：202501、2025-01、2025/01、2025-01-01
  if(/^[0-9]{6}$/.test(str)) return new Date(str.slice(0,4), str.slice(4,6)-1, 1);
  if(str.includes('-')||str.includes('/')){
    const parts=str.split(/[-/]/).map(p=>parseInt(p,10));
    if(parts.length>=2) return new Date(parts[0], parts[1]-1, parts[2]||1);
  }
  return null;
}

function loadFromUrl(){
  const url = CSV_URL + (CSV_URL.includes('?')?'&':'?') + 'cb=' + Date.now();
  Papa.parse(url, {
    header:true, download:true, skipEmptyLines:true,
    complete: (res)=>{
      const data=res.data;
      if(!data||!data.length){ alert("資料為空"); return; }
      renderChart(data);
    },
    error: (err)=>alert("讀取失敗："+err.message)
  });
}

function renderChart(rows){
  const months=parseInt(el.range.value,10);
  const now=new Date();
  const cutoff=new Date(now.getFullYear(), now.getMonth()-months, 1);

  const grouped={};
  rows.forEach(r=>{
    const d=parseDate(r['交易年月']);
    if(!d||d<cutoff) return;
    const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    if(!grouped[key]) grouped[key]={成交量:0, 價格:0, 筆數:0};
    grouped[key].成交量+=parseFloat(r['成交量']||0);
    grouped[key].價格+=parseFloat(r['均價_萬元每坪_平均']||0);
    grouped[key].筆數++;
  });

  const labels=Object.keys(grouped).sort();
  const volumes=labels.map(k=>grouped[k].成交量);
  const prices=labels.map(k=>grouped[k].筆數? grouped[k].價格/grouped[k].筆數 : 0);

  if(chart) chart.destroy();
  chart=new Chart(el.canvas,{
    type:'bar',
    data:{
      labels:labels,
      datasets:[
        {
          type:'bar',
          label:'成交量',
          data:volumes,
          yAxisID:'y1',
          backgroundColor:'rgba(75,192,192,0.5)',
          barThickness:20   // 固定長條寬度
        },
        {
          type:'line',
          label:'均價(萬/坪)',
          data:prices,
          yAxisID:'y2',
          borderColor:'rgba(255,99,132,1)',
          fill:false
        }
      ]
    },
    options:{
      responsive:true,
      interaction:{mode:'index',intersect:false},
      scales:{
        y1:{type:'linear', position:'left', title:{display:true,text:'成交量'}},
        y2:{type:'linear', position:'right', title:{display:true,text:'均價(萬/坪)'}, grid:{drawOnChartArea:false}}
      }
    }
  });
}

// event
el.range.addEventListener('change', loadFromUrl);
el.reload.addEventListener('click', loadFromUrl);
el.inspect.addEventListener('click', async ()=>{
  try{
    const url = CSV_URL + (CSV_URL.includes('?')?'&':'?') + 'cb=' + Date.now();
    const resp = await fetch(url);
    const text = await resp.text();
    alert((text||'').slice(0,500) || '（空字串）');
  }catch(e){ alert("抓取失敗："+e.message); }
});

loadFromUrl();
</script>
</body>
</html>
